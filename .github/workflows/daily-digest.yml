name: AI Daily Digest Generator

# è§¦å‘æ¡ä»¶ï¼šæ¯å¤©å®šæ—¶æ‰§è¡Œ + æ‰‹åŠ¨è§¦å‘
on:
  schedule:
    # æ—©ä¸Š9ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ 09:00 = UTC 01:00ï¼‰
    - cron: '0 1 * * *'
    # ä¸‹åˆ6ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ 18:00 = UTC 10:00ï¼‰
    - cron: '0 10 * * *'
  workflow_dispatch:  # æ”¯æŒåœ¨ GitHub é¡µé¢æ‰‹åŠ¨è§¦å‘

jobs:
  generate-digest:
    runs-on: ubuntu-latest

    # è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º 30 åˆ†é’Ÿ
    timeout-minutes: 30

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºæ¨é€

      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'  # å¯ç”¨ pip ç¼“å­˜åŠ é€Ÿ

      # 3. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. è¿è¡Œæ¯æ—¥ç®€æŠ¥ç”Ÿæˆ
      - name: Run daily digest generation
        env:
          ZHIPUAI_API_KEY: ${{ secrets.ZHIPUAI_API_KEY }}
          NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "========================================"
          echo "å¼€å§‹æ‰§è¡Œ AI æ¯æ—¥çƒ­ç‚¹ç”Ÿæˆ..."
          echo "æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "========================================"

          python src/main.py --mode auto --once

          echo "========================================"
          echo "AI æ¯æ—¥çƒ­ç‚¹ç”Ÿæˆå®Œæˆ"
          echo "========================================"

      # 5. æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ•°æ®ç”Ÿæˆ
      - name: Check for new data
        id: check-data
        run: |
          if [ -d "data/daily" ]; then
            echo "has_data=true" >> $GITHUB_OUTPUT

            # è·å–æœ€æ–°çš„æ—¥æœŸç›®å½•
            latest_dir=$(ls -t data/daily/ | head -1)
            echo "latest_dir=$latest_dir" >> $GITHUB_OUTPUT

            # æ£€æŸ¥æ˜¯å¦æœ‰ digest æ–‡ä»¶
            if [ -f "data/daily/$latest_dir/digest/digest_"*".md" ]; then
              echo "has_digest=true" >> $GITHUB_OUTPUT

              # æ˜¾ç¤ºç”Ÿæˆå†…å®¹æ‘˜è¦
              digest_file=$(ls -t data/daily/$latest_dir/digest/digest_*.md | head -1)
              echo "digest_file=$digest_file" >> $GITHUB_OUTPUT

              # æå–æ ‡é¢˜
              title=$(head -1 "$digest_file")
              echo "digest_title=$title" >> $GITHUB_OUTPUT
            else
              echo "has_digest=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_data=false" >> $GITHUB_OUTPUT
          fi

      # 6. æäº¤å¹¶æ¨é€åˆ° GitHub
      - name: Commit and push changes
        if: steps.check-data.outputs.has_data == 'true' && steps.check-data.outputs.has_digest == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # æ·»åŠ æ‰€æœ‰æ•°æ®æ–‡ä»¶
          git add data/

          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --cached --quiet; then
            echo "æ²¡æœ‰æ–°çš„æ•°æ®éœ€è¦æäº¤"
          else
            # è·å–æ—¥æœŸä½œä¸ºæäº¤ä¿¡æ¯
            commit_date=$(date +%Y-%m-%d)
            commit_time=$(date +%H:%M:%S)

            # æäº¤æ›´æ”¹
            git commit -m "feat: AIå†…å®¹è‡ªåŠ¨ç”Ÿæˆ - $commit_date

ğŸ“… ç”Ÿæˆæ—¶é—´: $commit_date
ğŸ¤– Generated by [ContentForge AI](https://github.com/devfoxaicn/content-forge-ai)

Co-Authored-By: GitHub Actions <github-actions[bot]@users.noreply.github.com>"

            # æ¨é€åˆ°è¿œç¨‹ä»“åº“
            git push

            echo "âœ… æ•°æ®å·²æˆåŠŸæäº¤åˆ° GitHub!"
          fi

      # 7. ç”Ÿæˆæ‘˜è¦æŠ¥å‘Š
      - name: Summary report
        if: always()
        run: |
          echo "========================================"
          echo "ğŸ“Š AI Daily Digest ç”ŸæˆæŠ¥å‘Š"
          echo "========================================"
          echo "æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "æ‰§è¡ŒçŠ¶æ€: ${{ job.status }}"

          if [ "${{ steps.check-data.outputs.has_digest }}" = "true" ]; then
            echo "ç®€æŠ¥æ ‡é¢˜: ${{ steps.check-data.outputs.digest_title }}"
            echo "æ•°æ®ç›®å½•: data/daily/${{ steps.check-data.outputs.latest_dir }}"
            echo "ç®€æŠ¥æ–‡ä»¶: ${{ steps.check-data.outputs.digest_file }}"
            echo "çŠ¶æ€: âœ… ç”ŸæˆæˆåŠŸ"
          else
            echo "çŠ¶æ€: âš ï¸ æœªç”Ÿæˆæ–°æ•°æ®"
          fi

          echo "========================================"
